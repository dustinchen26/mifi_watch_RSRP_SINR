<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>數據解析器與圖表</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    textarea {
      width: calc(100% - 150px);
      height: 300px;
      font-size: 16px;
      margin-right: 10px;
      display: inline-block;
    }
    button {
      padding: 10px;
      font-size: 16px;
      display: inline-block;
    }
    .container {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
      margin-top: 20px;
    }
    .canvas-container {
      flex: 1;
    }
    table {
      width: auto;
      border-collapse: collapse;
      margin-top: 20px;
      table-layout: auto;
    }
    th, td {
      padding: 5px 10px;
      text-align: left;
      border: 1px solid #ccc;
    }
    th {
      background-color: #f2f2f2;
    }
    canvas {
      max-width: 100%;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h1>數據解析器與圖表</h1>
<div>
  <textarea id="inputText" placeholder="請在此處輸入數據..."></textarea>
  <br>
  <button onclick="parseData()">解析數據</button>
</div>

<div class="container">
  <div class="canvas-container">
    <canvas id="rsrpChart"></canvas>
  </div>
  <div class="canvas-container">
    <canvas id="sinrChart"></canvas>
  </div>
</div>

<table id="outputTable">
  <thead>
    <tr>
      <th>Time</th>
      <th>RSRP</th>
      <th>SINR</th>
      <th>RX0</th>
      <th>RX1</th>
      <th>RX2</th>
      <th>RX3</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>

<script>
  let rsrpChart = null;
  let sinrChart = null;

  function parseData() {
    const inputText = document.getElementById('inputText').value.trim();
    const lines = inputText.split('\n').filter(line => line.trim() !== '');
    let time1 = '';
    let rsrpAndSinr = '';
    let rxData = { rx0: '', rx1: '', rx2: '', rx3: '' };
    
    const times = [];
    const rsrps = [];
    const sinrs = [];
    const rx0s = [];
    const rx1s = [];
    const rx2s = [];
    const rx3s = [];

    // 清空表格和圖表
    const tbody = document.querySelector('#outputTable tbody');
    tbody.innerHTML = '';
    if (rsrpChart) rsrpChart.destroy();
    if (sinrChart) sinrChart.destroy();

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();

      // 解析時間格式 (例如：2024-11-24 08:04:12)
      const timeMatch = line.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/);
      if (timeMatch) {
        time1 = timeMatch[1];
      }

      // 解析 RSRP 和 SINR (例如：RSRQ -11 dB, RSRP -78 dBm, SINR 32 dB)
      const rsrpSinrMatch = line.match(/RSRQ\s*(-?\d+)\s*dB,\s*RSRP\s*(-?\d+)\s*dBm,\s*SINR\s*(-?\d+)\s*dB/);
      if (rsrpSinrMatch) {
        rsrpAndSinr = `RSRP ${rsrpSinrMatch[2]} dBm, SINR ${rsrpSinrMatch[3]} dB`;
      }

      // 解析 RX0 到 RX3 的數據
      const rxMatch = line.match(/(RX[0-3])\s*power:\s*(-?\d+)\s*dBm,.*rsrp:\s*(-?\d+)\s*dBm/);
      if (rxMatch) {
        const rxIndex = rxMatch[1].toLowerCase();
        const rsrpValue = rxMatch[3];
        if (rxIndex === 'rx0') {
          rxData.rx0 = `RX0 rsrp: ${rsrpValue} dBm`;
        } else if (rxIndex === 'rx1') {
          rxData.rx1 = `RX1 rsrp: ${rsrpValue} dBm`;
        } else if (rxIndex === 'rx2') {
          rxData.rx2 = `RX2 rsrp: ${rsrpValue} dBm`;
        } else if (rxIndex === 'rx3') {
          rxData.rx3 = `RX3 rsrp: ${rsrpValue} dBm`;
        }
      }

      // 每次處理完一行後，如果我們已經有所有的數據，組裝並顯示
      if (time1 && rsrpAndSinr && rxData.rx0 && rxData.rx1 && rxData.rx2 && rxData.rx3) {
        // 創建新行並添加至表格
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
          <td>${time1}</td>
          <td>${rsrpAndSinr.split(', ')[0]}</td>
          <td>${rsrpAndSinr.split(', ')[1]}</td>
          <td>${rxData.rx0}</td>
          <td>${rxData.rx1}</td>
          <td>${rxData.rx2}</td>
          <td>${rxData.rx3}</td>
        `;
        tbody.appendChild(newRow);

        // 更新數據以便繪製圖表
        times.push(time1);
        rsrps.push(parseInt(rsrpAndSinr.split(', ')[0].split(' ')[1]));
        sinrs.push(parseInt(rsrpAndSinr.split(', ')[1].split(' ')[1]));
        rx0s.push(parseInt(rxData.rx0.split(' ')[2]));
        rx1s.push(parseInt(rxData.rx1.split(' ')[2]));
        rx2s.push(parseInt(rxData.rx2.split(' ')[2]));
        rx3s.push(parseInt(rxData.rx3.split(' ')[2]));

        // 重置數據以便處理下一組數據
        time1 = rsrpAndSinr = '';
        rxData = { rx0: '', rx1: '', rx2: '', rx3: '' };
      }
    }

    // 畫出圖表
    if (times.length > 0) {
      const rsrpCtx = document.getElementById('rsrpChart').getContext('2d');
      rsrpChart = new Chart(rsrpCtx, {
        type: 'line',
        data: {
          labels: times,
          datasets: [
            {
              label: 'RSRP',
              data: rsrps,
              borderColor: 'rgb(255, 99, 132)',
              fill: false,
            },
            {
              label: 'RX0',
              data: rx0s,
              borderColor: 'rgb(75, 192, 192)',
              fill: false,
            },
            {
              label: 'RX1',
              data: rx1s,
              borderColor: 'rgb(153, 102, 255)',
              fill: false,
            },
            {
              label: 'RX2',
              data: rx2s,
              borderColor: 'rgb(255, 159, 64)',
              fill: false,
            },
            {
              label: 'RX3',
              data: rx3s,
              borderColor: 'rgb(255, 205, 86)',
              fill: false,
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { 
              type: 'category', 
              title: { display: true, text: 'Time' }
            },
            y: { 
              beginAtZero: false, 
              title: { display: true, text: 'Value' }
            }
          }
        }
      });

      const sinrCtx = document.getElementById('sinrChart').getContext('2d');
      sinrChart = new Chart(sinrCtx, {
        type: 'line',
        data: {
          labels: times,
          datasets: [
            {
              label: 'SINR',
              data: sinrs,
              borderColor: 'rgb(54, 162, 235)',
              fill: false,
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: { 
              type: 'category', 
              title: { display: true, text: 'Time' }
            },
            y: { 
              beginAtZero: false, 
              title: { display: true, text: 'SINR' }
            }
          }
        }
      });
    }
  }
</script>

</body>
</html>
